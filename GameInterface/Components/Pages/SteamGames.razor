@page "/steamGames"
@inject ISteamService SteamService
@inject ISnackbar Snackbar

<GamesLoaderComponent Title="Jeux steam à récupérer"
    Games="LoaderSteamGames"
    LoadGame="LoadSteamGames"
    AddGame="AddSteamGame"
    IgnoreGame="IgnoreSteamGame">
</GamesLoaderComponent>


@code {
    private List<GameLoader> LoaderSteamGames { get; set; } = [];
    private List<SteamGameDto> SteamGameDtos { get; set; } = [];

    private async Task LoadSteamGames()
    {
        SteamGameDtos = await SteamService.GetMissingSteamGames();
        LoaderSteamGames = SteamGameDtos.Select(sg => sg.ToGameLoader()).ToList();
    }

    private async Task AddSteamGame(GameLoader steamGame)
    {
        var steamGameDto = FindSteamGame(steamGame);
        await SteamService.AddSteamGame(steamGameDto);
        Snackbar.Add($"Le jeu {steamGame.Name} a bien été ajouté à votre bibliothèque.", Severity.Success);
        SteamGameDtos.Remove(steamGameDto);
    }

    private async Task IgnoreSteamGame(GameLoader steamGame)
    {
        var steamGameDto = FindSteamGame(steamGame);
        await SteamService.IgnoreSteamGame(steamGameDto, true);
        Snackbar.Add($"Le jeu {steamGame.Name} a bien été ignoré.", Severity.Success);
        SteamGameDtos.Remove(steamGameDto);
    }

    private SteamGameDto FindSteamGame(GameLoader gameLoader) => SteamGameDtos.First(sg => sg.SteamId == int.Parse(gameLoader.Id));
}
