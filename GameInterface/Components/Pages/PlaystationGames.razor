@page "/playstationGames"
@inject IPlaystationService PlaystationService
@inject ISnackbar Snackbar

<GamesLoaderComponent Title="Jeux playstation à récupérer"
                      Games="LoaderPlaystationGames"
                      LoadGame="LoadPlaystationGames"
                      AddGame="AddPlaystationGame"
                      IgnoreGame="IgnorePlaystationGame">
</GamesLoaderComponent>


@code {
    private List<GameLoader> LoaderPlaystationGames { get; set; } = [];
    private List<PlaystationGameDto> PlaystationGameDtos { get; set; } = [];

    private async Task LoadPlaystationGames()
    {
        PlaystationGameDtos = await PlaystationService.GetMissingPlaystationGames();
        LoaderPlaystationGames = PlaystationGameDtos.Select(sg => sg.ToGameLoader()).ToList();
    }

    private async Task AddPlaystationGame(GameLoader playstationGame)
    {
        var steamGameDto = FindPlaystationGame(playstationGame);
        await PlaystationService.AddPlaystationGame(steamGameDto);
        Snackbar.Add($"Le jeu {playstationGame.Name} a bien été ajouté à votre bibliothèque.", Severity.Success);
        PlaystationGameDtos.Remove(steamGameDto);
    }

    private async Task IgnorePlaystationGame(GameLoader steamGame)
    {
        var steamGameDto = FindPlaystationGame(steamGame);
        await PlaystationService.IgnorePlaystationGame(steamGameDto, true);
        Snackbar.Add($"Le jeu {steamGame.Name} a bien été ignoré.", Severity.Success);
        PlaystationGameDtos.Remove(steamGameDto);
    }

    private PlaystationGameDto FindPlaystationGame(GameLoader gameLoader) => PlaystationGameDtos.First(sg => sg.PlaystationId == gameLoader.Id);
}
