@page "/playstationGames"
@inject IPlaystationService PlaystationService
@inject ISnackbar Snackbar

<SimpleGamesComponent Options="SimpleGamesComponentOptions"
                      Games="SimpleGames"
                      LoadGame="LoadPlaystationGames"
                      AddGame="AddPlaystationGame"
                      IgnoreGame="IgnorePlaystationGame">
</SimpleGamesComponent>


@code {
    private List<SimpleGame> SimpleGames { get; set; } = [];
    private List<PlaystationGameDto> PlaystationGameDtos { get; set; } = [];
    private SimpleGamesComponentOptions SimpleGamesComponentOptions { get; set; } = new()
    {
        Title = "Jeux playstation à récupérer",
        HasColumnPlatform = true
    };

    private async Task LoadPlaystationGames()
    {
        var getMissingPlaystationGamesResult = await PlaystationService.GetMissingPlaystationGames();
        if (getMissingPlaystationGamesResult.IsSucceed)
        {
            PlaystationGameDtos = getMissingPlaystationGamesResult.Result!;
            SimpleGames = PlaystationGameDtos.Select(sg => sg.ToGameLoader()).ToList();
        }
    }

    private async Task AddPlaystationGame(SimpleGame playstationGame)
    {
        var steamGameDto = FindPlaystationGame(playstationGame);
        var addPlaystationGameResult = await PlaystationService.AddPlaystationGame(steamGameDto);
        if (addPlaystationGameResult.IsSucceed)
        {
            Snackbar.Add($"Le jeu {playstationGame.Name} a bien été ajouté à votre bibliothèque.", Severity.Success);
            PlaystationGameDtos.Remove(steamGameDto);
        }
    }

    private async Task IgnorePlaystationGame(SimpleGame steamGame)
    {
        var steamGameDto = FindPlaystationGame(steamGame);
        var ignorePlaystationGameResult = await PlaystationService.IgnorePlaystationGame(steamGameDto, true);
        if (ignorePlaystationGameResult.IsSucceed)
        {
            Snackbar.Add($"Le jeu {steamGame.Name} a bien été ignoré.", Severity.Success);
            PlaystationGameDtos.Remove(steamGameDto);
        }
    }

    private PlaystationGameDto FindPlaystationGame(SimpleGame gameLoader) => PlaystationGameDtos.First(sg => sg.PlaystationId == gameLoader.Id);
}
